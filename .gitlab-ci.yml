variables:

    CODE_IMAGE: $CI_REGISTRY_IMAGE/$CI_PROJECT_NAME:$CI_COMMIT_SHA

stages:
  - npm
  - build
  - deploy


npm:
  stage: npm
  image: node
  tags:
    - docker
  only:
  - production

  artifacts:
    paths:
    - ./build/

  cache:
    paths:
      - node_modules

  script:
    - apt-get update; apt-get -y install curl
    - curl -sS https://dl.yarnpkg.com/debian/pubkey.gpg | apt-key add -
    - echo "deb https://dl.yarnpkg.com/debian/ stable main" | tee /etc/apt/sources.list.d/yarn.list
    - apt-get update && apt-get -y install yarn
    - yarn
    - npm run build
    - ls -la ./

build:
  stage: build
  dependencies:
    - npm
  image: docker:latest
  tags:
    - docker
  services:
    - docker:dind
  only:
  - production

  script:
    - ls -la ./
    - echo "$CI_REGISTRY_PASSWORD" | docker login -u "$CI_REGISTRY_USER" "$CI_REGISTRY" --password-stdin
    - docker build --tag="$CODE_IMAGE" .
    - docker push $CODE_IMAGE

deploy:
  environment:
    name: production
    url: lma.maxipost.com
  when: manual
  only:
  - production
  stage: deploy
  dependencies:
    - build
  tags:
    - docker
  image: docker:latest
  services:
    - docker:dind
  script:
    - echo "$KUBERNETES_CONFIG" > config
    - sed -i "s/FULL_APP_NAME/${CI_PROJECT_PATH_SLUG}/g" namespace.yaml
    - sed -i "s/BRANCH_ENVIRONMENT/${CI_ENVIRONMENT_SLUG}/g" namespace.yaml
    - sed -i "s/CI_JOB_ID/${CI_JOB_ID}/g" deploy-service.yaml
    - sed -i "s/COMMIT_SHA/${CI_COMMIT_SHA}/g" deploy-service.yaml
    - sed -i "s/FULL_APP_NAME/${CI_PROJECT_PATH_SLUG}/g" deploy-service.yaml
    - sed -i "s/BRANCH_ENVIRONMENT/${CI_ENVIRONMENT_SLUG}/g" deploy-service.yaml
    - sed -i "s~GITLAB_DOCKER_REGISTRY_IMAGE~${CI_REGISTRY_IMAGE}~g" deploy-service.yaml
    - sed -i "s/SHORT_APP_NAME/${CI_PROJECT_NAME}/g" deploy-service.yaml
    - sed -i "s/INGRESS_HOSTNAME/${CI_ENVIRONMENT_URL}/g" deploy-service.yaml
    - docker run -v ${PWD}/config:/root/.kube/config -v ${PWD}/namespace.yaml:/namespace.yaml lachlanevenson/k8s-kubectl:v1.10.3 apply -f /namespace.yaml
    - docker run -v ${PWD}/config:/root/.kube/config lachlanevenson/k8s-kubectl:v1.10.3 -n $CI_PROJECT_PATH_SLUG-$CI_ENVIRONMENT_SLUG create secret docker-registry regcred --docker-server=$CI_REGISTRY --docker-username=$CI_REGISTRY_USER --docker-password=$CI_REGISTRY_PASSWORD --docker-email=$GITLAB_USER_EMAIL || true
    - docker run -v ${PWD}/config:/root/.kube/config -v ${PWD}/deploy-service.yaml:/deploy-service.yaml lachlanevenson/k8s-kubectl:v1.10.3 apply -f /deploy-service.yaml
    - echo "${CI_ENVIRONMENT_URL} Deployed"
